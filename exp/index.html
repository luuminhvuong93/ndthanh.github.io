<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .expectation {
            margin: 10px;
            padding: 10px;
            border: 1px solid #888888;
        }
    </style>
</head>
<body>
    <h2>Expectation Editor</h2>
    <input type="button" value="Add Expectation" id="add-expectation">
    <input type="button" value="Save Expectations" id="save-expectation">
    <div id="expectations">
        
    </div>
<script>
    (function() {
        var App = {};
        App = {
            init() {
                var addExpectation = document.getElementById('add-expectation');
                addExpectation.addEventListener('click', App.createExpectation);

                var saveExpectations = document.getElementById('save-expectation');
                saveExpectations.addEventListener('click', App.saveAllExpectation);
            },
            saveAllExpectation() {
                let expectations = document.getElementsByClassName('expectation');
                var mappingUsedByThisExpectation = [];
                
                // id của những mapping đang được "soạn bài"
                let expectationIds = Array.from(expectations).map((expectation) => {
                    return expectation.querySelector('.select-test').options.selectedIndex;
                })

                // console.log(expectationIds);
                // array gồm toàn bộ mapping ids
                let mappingIds = App.mapping.map((oneMapping) => oneMapping.id);

                expectationIds.map((id) => {
                    var mapping = App.mapping.filter(m => m.id == id);
                    mappingUsedByThisExpectation.push(mapping[0]);
                })

                // console.log(mappingUsedByThisExpectation);
                // lấy giá trị params của các mapping
                
                let tests = Array.from(expectations).map((expectation) => {
                    var paramsArray = expectation.querySelector('.expectation-params').children;
                    return Array.from(paramsArray).map((p, index) => {
                        return {
                            technicalName: p.getAttribute('data-technical-name'),
                            paramValue: p.value
                        }
                    });
                });
                // console.log(tests);
                tests.map((t, idx) => {
                    // var mappingParams = mappingUsedByThisExpectation[idx].params;
                    // console.log(mappingUsedByThisExpectation[idx].params);
                    mappingUsedByThisExpectation[idx].params.map((mp,i) => {
                        // mp[i].value = t[i].paramValue;
                        console.log(tests[idx][i].paramValue);
                        mp.value = tests[idx][i].paramValue;
                        console.log("----------");
                        console.log(mp.value);

                        // console.log(mp);
                        // mp.value = i + "|" + idx;
                        // console.log(mp.value);
                    });
                    // console.log(mappingParams);
                    // t.map((paramArray, i)=>{
                    //     console.log(`mappingUsedByThisExpectation[${idx}].params[${i}].value = ${paramArray.paramValue}`);
                    //     console.log("--------------------------------");
                    //     mappingParams[i].value = paramArray.paramValue;
                    // });
                });

                // Đoạn trên chưa debug được nên dùng tạm vòng lặp bình thường:

                // for(let i = 0; i < tests.length; i ++){
                //     for(let j = 0; j < tests[i].length; j ++){
                //         mappingUsedByThisExpectation[i].params[j].value = tests[i][j].paramValue;
                //     }
                // }

                console.log(mappingUsedByThisExpectation);
            },
            createExpectation() {
                var expectations = document.getElementById('expectations');
                var expectation = document.createElement('div');
                expectation.className = 'expectation';
                var html = `
                <div class="expectation-test">
                    <select class="select-test">
                        <option value="0">Chọn 1 test</option>
                `;
                // generate option list từ mapping
                
                var options = App.mapping.map((oneMapping) => {
                    return `<option value="${oneMapping.id}">${oneMapping.func.friendlyName}</option>`
                });
                html += options;
                html += `
                    </select>
                    </div>
                    <div class="expectation-params">
                        <!-- generate params for test here -->
                    </div>
                    <p class="expectation-explanation"></p>
                `;
                expectation.innerHTML = html;

                expectation.querySelector('.select-test').addEventListener('change', App.OnSelectTestChange)
                
                expectations.appendChild(expectation);
            },
            OnSelectTestChange(e) {
                var id = parseInt(e.target.options[e.target.options.selectedIndex].value); // lấy id tương ứng
                
                var test = App.mapping.filter(oneMapping => oneMapping.id == id);          // tìm ID của mapping tương ứng
                
                var paramsDiv = e.target.parentNode.parentNode.querySelector('.expectation-params');
                paramsDiv.innerHTML = App.genParams(test[0].params);

                var explanationDiv = e.target.parentNode.parentNode.querySelector('.expectation-explanation');
                explanationDiv.innerHTML = test[0].explanation;
            },

            genParams(paramsArray) {
                return paramsArray.map((param) => {
                    return `<input 
                                type="text"
                                data-technical-name="${param.technicalName}"
                                placeholder="${param.friendlyName}">`
                });
            },
            testCases: {
                Should_ReturnTrue_When_NumberOfWorksheetsEqual( number ) {
                    return number == 5;
                }
            },
            utility: {
                // https://gist.github.com/ndthanh/c860b8b9b5a9e545337021d1ca395b77
                executeFunctionByName(functionName, context /*, args */) {
                    var args = Array.prototype.slice.call(arguments, 2);
                    var namespaces = functionName.split(".");
                    var func = namespaces.pop();
                    for(var i = 0; i < namespaces.length; i++) {
                        context = context[namespaces[i]];
                    }
                    return context[func].apply(context, args);
                }
            },
            mapping: [
                {
                    id: 1,
                    explanation: "Kiểm tra số lượng worksheets có bằng {0} hay không",
                    func: {
                        technicalName: "Should_ReturnTrue_When_NumberOfWorksheetsEqual",
                        friendlyName: "Kiểm tra số lượng Worksheets trong một Workbook"
                    },
                    params: [
                        {
                            technicalName: "numberOfWorksheets",
                            friendlyName: "Số lượng Worksheets"
                        }
                    ]
                },
                {
                    id: 2,
                    explanation: "Kiểm tra sheet ở vị trí {0} có tên là {1} hay không?",
                    func: {
                        technicalName: "Should_ReturnTrue_WhenRightSheetNameByIndex",
                        friendlyName: "Kiểm tra tên Worksheet bằng số thứ tự"
                    },
                    params: [
                        {
                            technicalName: "sheetName",
                            friendlyName: "Tên Worksheet"
                        },
                        {
                            technicalName: "sheetIndex",
                            friendlyName: "Số thứ tự của Worksheet cần kiểm tra"
                        }
                    ]
                },
                {
                    id: 3,
                    explanation: "Dummy Expectation để test",
                    func: {
                        technicalName: "ToTest",
                        friendlyName: "Expectation để test"
                    },
                    params: [
                        {
                            technicalName: "sheetName",
                            friendlyName: "Tên Worksheet"
                        },
                        {
                            technicalName: "sheetIndex",
                            friendlyName: "Số thứ tự của Worksheet cần kiểm tra"
                        }
                        ,
                        {
                            technicalName: "workbookName",
                            friendlyName: "Tên Workbook"
                        }
                    ]
                }
            ]

        }

        App.init();
    })();
</script>
</body>
</html>